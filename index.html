<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Matrix Cam (Fixed Switch)</title>
    <style>
        body {
            background-color: #000;
            margin: 0;
            overflow: hidden;
            font-family: 'Courier New', monospace;
            touch-action: none; /* Prevents browser zooming */
        }

        canvas {
            display: block;
            width: 100vw;
            height: 100vh;
        }

        /* UI Container */
        .ui-container {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            width: 95%;
            max-width: 500px;
            background: rgba(10, 10, 10, 0.9);
            border: 1px solid #444;
            padding: 10px;
            border-radius: 15px;
            z-index: 100;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .ui-hidden { display: none; }

        /* Buttons */
        button {
            background: #eee; color: black; border: none;
            height: 45px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
        }
        
        #btnStart { flex-grow: 2; }
        #btnSwitch { flex-grow: 1; background: #444; color: white; font-size: 20px;}
        #btnSnap { flex-grow: 1; background: #ff4444; color: white;}

        /* Slider */
        .slider-box { flex-grow: 3; display: flex; flex-direction: column; padding: 0 5px; }
        label { color: #888; font-size: 10px; margin-bottom: 2px;}
        input[type=range] { width: 100%; }

        video { display: none; }
        
        .debug-msg {
            position: absolute; top: 10px; left: 10px; 
            color: lime; background: rgba(0,0,0,0.5); 
            font-size: 10px; pointer-events: none;
        }
    </style>
</head>
<body>

    <div class="debug-msg" id="debug">Ready.</div>

    <div class="ui-container" id="ui">
        <button onclick="toggleCamera()" id="btnStart">START</button>
        <button onclick="switchCamera()" id="btnSwitch">â†»</button>
        
        <div class="slider-box">
            <label>BRIGHTNESS</label>
            <input type="range" id="contrast" min="0" max="255" value="80">
        </div>
        
        <button onclick="takeSnapshot()" id="btnSnap">ðŸ“·</button>
    </div>

    <video id="video" playsinline autoplay muted></video>
    <canvas id="canvas"></canvas>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const debug = document.getElementById('debug');
        
        const GLYPHS = "  .:-~=+*#%@";
        
        let streaming = false;
        let animationId;
        let useFrontCamera = true; // Track which camera we want

        // --- CAMERA LOGIC ---

        async function startStream() {
            // Stop existing if any
            if(video.srcObject) {
                video.srcObject.getTracks().forEach(t => t.stop());
            }

            // Define Constraints
            // We use 'ideal' instead of 'exact' so it doesn't crash if the camera is missing
            const constraints = {
                video: {
                    facingMode: useFrontCamera ? "user" : "environment",
                    width: { ideal: 640 }, // Lower res runs faster
                    height: { ideal: 480 }
                }
            };

            try {
                debug.innerText = `Requesting: ${useFrontCamera ? "Front" : "Back"}...`;
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                // Wait for video to actually start
                video.onloadedmetadata = () => {
                    video.play();
                    streaming = true;
                    document.getElementById('btnStart').innerText = "STOP";
                    debug.innerText = "Running: " + (useFrontCamera ? "Front" : "Back");
                    loop();
                };
            } catch (err) {
                console.error(err);
                alert("Camera Error: " + err.name + "\n(Make sure you are using HTTPS!)");
                debug.innerText = "Error: " + err.name;
            }
        }

        function toggleCamera() {
            if (streaming) {
                streaming = false;
                cancelAnimationFrame(animationId);
                if(video.srcObject) {
                    video.srcObject.getTracks().forEach(t => t.stop());
                    video.srcObject = null;
                }
                document.getElementById('btnStart').innerText = "START";
                ctx.fillStyle = "black";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else {
                startStream();
            }
        }

        function switchCamera() {
            if (!streaming) return;
            // Flip the boolean
            useFrontCamera = !useFrontCamera;
            // Restart
            startStream();
        }

        // --- RENDER LOOP ---

        function loop() {
            if (!streaming) return;

            // 1. Resize Canvas if needed
            if (canvas.width !== window.innerWidth || canvas.height !== window.innerHeight) {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            const w = canvas.width;
            const h = canvas.height;

            // 2. Settings
            const contrastVal = parseInt(document.getElementById('contrast').value);
            const fontSize = Math.max(8, w / 70); // Dynamic text size
            const cols = Math.ceil(w / fontSize);
            const rows = Math.ceil(h / (fontSize * 0.8));

            // 3. Process Video
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = cols;
            tempCanvas.height = rows;

            // MIRROR LOGIC:
            // Only mirror if using Front Camera
            if (useFrontCamera) {
                tempCtx.translate(cols, 0);
                tempCtx.scale(-1, 1);
            }

            // Draw video to tiny canvas
            tempCtx.drawImage(video, 0, 0, cols, rows);
            const pixels = tempCtx.getImageData(0, 0, cols, rows).data;

            // 4. Draw Matrix
            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, w, h);
            
            ctx.font = `bold ${fontSize}px monospace`;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillStyle = "white";

            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    const i = (y * cols + x) * 4;
                    
                    // Grayscale
                    let gray = (pixels[i] + pixels[i+1] + pixels[i+2]) / 3;

                    // Apply Contrast
                    const factor = (259 * (contrastVal + 255)) / (255 * (259 - contrastVal));
                    gray = factor * (gray - 128) + 128;

                    if (gray < 30) continue; // Skip dark pixels

                    const charIndex = Math.floor((gray / 255) * (GLYPHS.length - 1));
                    const char = GLYPHS[Math.max(0, Math.min(GLYPHS.length-1, charIndex))];

                    ctx.fillText(char, x * fontSize + fontSize/2, y * (fontSize*0.8) + (fontSize*0.4));
                }
            }

            animationId = requestAnimationFrame(loop);
        }

        function takeSnapshot() {
            const link = document.createElement('a');
            link.download = 'matrix.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        // Tap to hide UI (Optional)
        document.body.addEventListener('click', (e) => {
            if(!e.target.closest('.ui-container')) {
                document.getElementById('ui').classList.toggle('ui-hidden');
            }
        });

    </script>
</body>
</html>
